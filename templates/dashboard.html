<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D'Kristin - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="static/logo.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
     @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

:root {
    --primary-color: #FF8C00;
    --primary-light: #FFB74D;
    --primary-dark: #F57C00;
    --accent-color: #FF4081;
    --text-primary: #2C3E50;
    --text-secondary: #607D8B;
    --background: #FFFFFF;
    --card-bg: #F8F9FA;
    --success: #4CAF50;
    --warning: #FFC107;
    --danger: #F44336;
    --border-color: #E0E0E0;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--background);
    color: var(--text-primary);
    min-height: 100vh;
}

.dashboard {
    display: grid;
    grid-template-columns: 280px 1fr;
    min-height: 100vh;
    background: linear-gradient(135deg, #FFF5E6 0%, #FFFFFF 100%);
}

/* Sidebar estilizado */
.sidebar {
    background: white;
    padding: 2rem;
    box-shadow: 2px 0 20px rgba(0,0,0,0.05);
}

.logo-container {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--primary-light);
}

.logo-text {
    font-size: 2.5rem;
    font-family: 'Playfair Display', serif;
}

.logo-text .d {
    color: var(--primary-color);
    font-style: italic;
}

.logo-text .apostrophe {
    color: var(--accent-color);
    font-style: italic;
}

.logo-text .kristin {
    background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

.salon-text {
    color: var(--text-secondary);
    font-size: 0.875rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 0.5rem;
}

.menu-section {
    margin-top: 2rem;
}

.menu-link {
    display: flex;
    align-items: center;
    padding: 1rem;
    color: var(--text-primary);
    text-decoration: none;
    border-radius: 12px;
    margin-bottom: 0.8rem;
    position: relative;
    overflow: hidden;
}

.menu-link:hover, .menu-link.active {
    background: linear-gradient(45deg, var(--primary-light), var(--primary-color));
    color: white;
    transform: translateX(5px);
}

.menu-link i {
    width: 24px;
    margin-right: 1rem;
    font-size: 1.2rem;
}

/* Main Content */
.main-content {
    padding: 2rem;
    overflow-y: auto;
}

.header {
    margin-bottom: 2rem;
    position: relative;
}

.header h1 {
    font-size: 2.5rem;
    font-weight: 600;
    color: var(--text-primary);
    position: relative;
    display: inline-block;
}

.header h1::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 60%;
    height: 3px;
    background: linear-gradient(to right, var(--primary-color), transparent);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 16px;
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-info h3 {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stat-info .number {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--text-primary);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.chart-header {
    margin-bottom: 1.5rem;
}

.chart-header h3 {
    font-size: 1.25rem;
    color: var(--text-primary);
    font-weight: 500;
}

/* Tablas */
.data-table {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.table-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(to right, white, #FFF5E6);
}

.table-header h2 {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 500;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 1.2rem 1.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

th {
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

td {
    color: var(--text-primary);
    font-size: 0.9rem;
}

/* Status badges */
.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pendiente {
    background: #FFF3E0;
    color: var(--primary-dark);
}

.status-cancelada {
    background: #FFEBEE;
    color: var(--danger);
}

.status-completada {
    background: #E0F2F1;
    color: #009688;
}

/* Hover effects */
tbody tr {
    transition: background-color 0.3s ease;
}

tbody tr:hover {
    background: #FFF5E6;
}

/* Responsive */
@media (max-width: 1024px) {
    .dashboard {
        grid-template-columns: 1fr;
    }

    .sidebar {
        display: none;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    /* Estilos del modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow-y: auto;
}

.modal-content {
    position: relative;
    background-color: #fff;
    margin: 2% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    animation: modalFadeIn 0.3s ease;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(to right, white, #FFF5E6);
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.5rem;
    font-weight: 600;
}

.modal-body {
    padding: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.95rem;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255,140,0,0.1);
}

select.form-control[multiple] {
    height: auto;
    min-height: 120px;
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-radius: 0 0 12px 12px;
    background: #fafafa;
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}

.btn-secondary {
    background-color: #e0e0e0;
    color: var(--text-primary);
}

.btn-secondary:hover {
    background-color: #d0d0d0;
    transform: translateY(-1px);
}

.close {
    color: var(--text-secondary);
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    padding: 0.5rem;
    line-height: 1;
    transition: all 0.3s ease;
}

.close:hover {
    color: var(--text-primary);
    transform: scale(1.1);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 1% auto;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .btn {
        padding: 0.6rem 1.2rem;
    }
}
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .main-content {
        padding: 1rem;
    }

    .header h1 {
        font-size: 2rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


.stat-card, .chart-card, .data-table {
    animation: fadeIn 0.5s ease forwards;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    position: relative;
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.5rem;
}

.close {
    color: var(--text-secondary);
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
}

.btn-secondary {
    background-color: #e0e0e0;
    color: var(--text-primary);
}

.btn-secondary:hover {
    background-color: #d0d0d0;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(255,140,0,0.1);
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    padding: 0.25rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-edit {
    color: var(--primary-color);
}

.btn-delete {
    color: var(--danger);
}

.btn-icon:hover {
    background-color: rgba(0,0,0,0.1);
}

/* Agregar botón nuevo en las tablas */
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.service-selector {
    margin-bottom: 1rem;
}

.service-selector select {
    margin-bottom: 0.5rem;
}

.selected-services {
    margin-top: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.services-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.services-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.services-list li:last-child {
    border-bottom: none;
}

.btn-remove {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
}

.btn-remove:hover {
    background-color: rgba(244, 67, 54, 0.1);
}

#agregar-servicio {
    margin-left: 0.5rem;
}

.service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
}

.service-item:last-child {
    border-bottom: none;
}

.total-field {
    font-weight: bold;
    color: var(--primary-color);
    background-color: #f8f9fa;
}

input[readonly].total-field {
    background-color: #f8f9fa;
    border-color: var(--border-color);
    font-weight: bold;
    color: var(--primary-color);
}

/* Estilos para el modal de historial */
.historial-modal {
    font-family: 'Poppins', sans-serif;
}

.historial-modal .swal2-popup {
    padding: 2rem;
    border-radius: 16px;
}

.historial-modal .swal2-title {
    font-size: 1.5rem;
    color: var(--text-primary);
    font-weight: 600;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.historial-container .stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 1rem;
}

.historial-container .text-2xl {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1.2;
    margin: 0.5rem 0;
}

.historial-container .text-sm {
    font-size: 0.875rem;
}

.historial-container .text-gray-600 {
    color: var(--text-secondary);
}

.historial-container .text-green-500 {
    color: var(--success);
    font-weight: 500;
}

.historial-container .text-orange-500 {
    color: var(--warning);
    font-weight: 500;
}

/* Tabla del historial */
.historial-table {
    margin-top: 2rem;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.historial-table table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.historial-table th {
    background: #f8f9fa;
    padding: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border-color);
}

.historial-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.historial-table tr:last-child td {
    border-bottom: none;
}

.historial-table tr:hover {
    background-color: #f8f9fa;
}

/* Status badges */
.historial-table .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

/* Servicios en el historial */
.servicio-item {
    padding: 0.5rem 0;
    border-bottom: 1px dashed var(--border-color);
}

.servicio-item:last-child {
    border-bottom: none;
}

.servicios-favoritos {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.servicios-favoritos .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.servicios-favoritos .count {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Totales */
.monto {
    font-weight: 700;
    color: var(--primary-color);
}

/* Media queries */
@media (max-width: 768px) {
    .historial-container {
        grid-template-columns: 1fr;
    }
    
    .historial-table {
        font-size: 0.875rem;
    }
    
    .historial-table th,
    .historial-table td {
        padding: 0.75rem;
    }
}

/* Mejoras visuales extra */
.swal2-modal {
    max-width: 90% !important;
    margin: 1.75rem auto;
}

.grid {
    display: grid;
    gap: 1rem;
}

.grid-cols-3 {
    grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 768px) {
    .grid-cols-3 {
        grid-template-columns: 1fr;
    }
}

/* Contenedor principal con layout fijo */
.search-filter-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    padding: 1rem 0;
}

/* Contenedor de búsqueda y filtros */
.search-filters-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

/* Caja de búsqueda */
.search-box {
    position: relative;
    flex: 1;
    min-width: 200px;
    max-width: 600px;
}

.search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid #f0f0f0;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.search-input:hover {
    border-color: var(--primary-color);
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255,140,0,0.1);
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 1rem;
    pointer-events: none;
}


/* Botón Nuevo mejorado */
.btn-add {
    white-space: nowrap;
}

.btn-add i {
    font-size: 0.95rem;
    transition: transform 0.3s ease;
}

/* Efectos hover compartidos */
.filter-select:hover,
.filter-date:hover,
.btn-add:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 140, 0, 0.2);
}

.filter-select:active,
.filter-date:active,
.btn-add:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(255, 140, 0, 0.1);
}

/* Efecto especial para el icono del botón nuevo */
.btn-add:hover i {
    transform: rotate(90deg);
}

/* Contenedor de filtros con espaciado mejorado */
.filters-box {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-left: auto;
    flex-wrap: nowrap;
}

/* Estilos base compartidos para filtros y botón nuevo */
.filter-select,
.filter-date,
.btn-add {
    min-width: 140px;
    max-width: fit-content;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    background-color: var(--primary-color);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    box-shadow: 0 2px 4px rgba(255, 140, 0, 0.1);
    margin: 0;  /* Eliminar márgenes por defecto */
}

/* Select de filtros */
.filter-select {
    appearance: none;
    padding-right: 2.5rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
    flex-shrink: 0;  /* Evitar que se encoja */
}

/* Contenedor del date picker con espaciado mejorado */
.date-filter-container {
    min-width: 140px;
    position: relative;
    margin: 0 1rem;  /* Espaciado horizontal consistente */
    flex-shrink: 0;  /* Evitar que se encoja */
}

.filter-date {
    width: 100%;
    appearance: none;
    padding-right: 2.5rem;  /* Espacio para el ícono */
}

/* Botón Nuevo mejorado */
.btn-add {
    white-space: nowrap;
    margin-left: 1rem;  /* Espaciado consistente */
    flex-shrink: 0;  /* Evitar que se encoja */
}

/* Ajustes específicos para mantener el espaciado */
.filter-select + .date-filter-container {
    margin-left: 1rem;  /* Espaciado entre filtro y date picker */
}

.date-filter-container + .btn-add {
    margin-left: 1rem;  /* Espaciado entre date picker y botón */
}

/* Media queries optimizados */
@media (max-width: 992px) {
    .filters-box {
        gap: 0.75rem;  /* Reducir gap en pantallas más pequeñas */
    }

    .filter-select,
    .filter-date,
    .btn-add {
        min-width: 120px;
        padding: 0.75rem;
    }

    .date-filter-container {
        margin: 0 0.75rem;  /* Reducir márgenes */
    }
}

@media (max-width: 768px) {
    .filters-box {
        width: 100%;
        justify-content: space-between;
        gap: 0.5rem;  /* Reducir aún más el gap */
    }

    .filter-select,
    .filter-date,
    .btn-add {
        flex: 1;
        min-width: auto;  /* Permitir que se ajusten al espacio disponible */
    }

    .date-filter-container {
        margin: 0 0.5rem;  /* Reducir márgenes aún más */
        flex: 1;
    }

    .btn-add {
        margin-left: 0.5rem;
    }
}

/* Prevenir pegado en tamaños muy pequeños */
@media (max-width: 576px) {
    .filters-box {
        flex-direction: column;
        width: 100%;
    }

    .filter-select,
    .date-filter-container,
    .btn-add {
        width: 100%;
        margin: 0.5rem 0;  /* Espaciado vertical */
    }

    .date-filter-container {
        margin: 0.5rem 0;
    }

    .btn-add {
        margin: 0.5rem 0;
    }
}

.historial-container {
    font-family: 'Poppins', sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    background: #fff;
}

.historial-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #FF8C00, #FF4081);
    border-radius: 15px;
    color: white;
}

.historial-header h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-item {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    border: 1px solid #f0f0f0;
}

.stat-item:hover {
    transform: translateY(-5px);
}

.stat-item i {
    font-size: 24px;
    color: #FF8C00;
    margin-bottom: 10px;
}

.stat-item .stat-value {
    display: block;
    font-size: 28px;
    font-weight: bold;
    color: #2C3E50;
    margin: 10px 0;
}

.stat-item .stat-label {
    color: #666;
    font-size: 14px;
}

.stat-item.warning i { color: #FFC107; }
.stat-item.pending i { color: #2196F3; }
.stat-item.success i { color: #4CAF50; }

.financial-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.finance-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.finance-card .amount {
    font-size: 24px;
    font-weight: bold;
    color: #FF8C00;
    margin-bottom: 5px;
}

.finance-card .label {
    color: #666;
    font-size: 14px;
}

.favorites-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.favorites-section h3 {
    color: #2C3E50;
    margin-bottom: 15px;
    font-size: 18px;
}

.favorites-section h3 i {
    color: #FF8C00;
    margin-right: 10px;
}

.favorites-list {
    display: grid;
    gap: 10px;
}

.favorite-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.favorite-item .badge {
    background: #FF8C00;
    color: white;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.historial-table {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.historial-table h3 {
    color: #2C3E50;
    margin-bottom: 20px;
    font-size: 18px;
}

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #2C3E50;
    border-bottom: 2px solid #eee;
}

td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.servicio-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.servicio-item .precio {
    color: #666;
}

.status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-badge.completada {
    background: #E8F5E9;
    color: #2E7D32;
}

.status-badge.pendiente {
    background: #FFF3E0;
    color: #E65100;
}

.status-badge.cancelada {
    background: #FFEBEE;
    color: #C62828;
}

@media (max-width: 768px) {
    .historial-container {
        padding: 10px;
    }

    .stats-row {
        grid-template-columns: repeat(2, 1fr);
    }

    .financial-info {
        grid-template-columns: 1fr;
    }

    .stat-item .stat-value {
        font-size: 24px;
    }

    .historial-header h2 {
        font-size: 20px;
    }
}
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo-container">
                    <img src="static/alquifiestas.png" alt="Logo de Calzada class="logo-img">
                </div>
            </div>

            <nav class="menu-section">
                <a href="#" class="menu-link active">
                    <i class="fas fa-home"></i>
                    Inicio
                </a>
                <a href="#" class="menu-link" data-collection="citas">
                    <i class="fas fa-calendar"></i>
                    Citas
                </a>
                <a href="#" class="menu-link" data-collection="visitas">
                    <i class="fas fa-walking"></i>
                    Visitas
                </a>
                <a href="#" class="menu-link" data-collection="clientes">
                    <i class="fas fa-users"></i>
                    Clientes
                </a>
                <a href="#" class="menu-link" data-collection="productos">
                    <i class="fas fa-box"></i>
                    Productos
                </a>
                <a href="#" class="menu-link" data-collection="servicios">
                    <i class="fas fa-concierge-bell"></i>
                    Servicios
                </a>
                <a href="#" class="menu-link" data-collection="usuarios">
                    <i class="fas fa-user"></i>
                    Usuarios
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1>Dashboard</h1>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Citas</h3>
                        <div class="number" id="total-citas">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-walking"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Visitas</h3>
                        <div class="number" id="total-visitas">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Clientes</h3>
                        <div class="number" id="total-clientes">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Productos</h3>
                        <div class="number" id="total-productos">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-concierge-bell"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Servicios</h3>
                        <div class="number" id="total-servicios">0</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Citas por Estado</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="citasChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Servicios más Solicitados</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="serviciosChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabla de Citas -->
            <div class="data-table" id="table-citas">
                <div class="table-header">
                    <h2>Citas Recientes</h2>
                </div>
                <table id="collection-table-citas">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Teléfono</th>
                            <th>Estilista</th>
                            <th>Servicio</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="data-table" id="table-visitas">
                <div class="table-header">
                    <h2>Registro de Visitas</h2>
                </div>
                <table id="collection-table-visitas">
                    <thead>
                        <tr>
                            <th>Visita</th>
                            <th>Teléfono</th>
                            <th>Estilista</th>
                            <th>Servicio</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Tabla de Clientes -->
            <div class="data-table" id="table-clientes">
                <div class="table-header">
                    <h2>Lista de Clientes</h2>
                </div>
                <table id="collection-table-clientes">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>NIT</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Tabla de Productos -->
            <div class="data-table" id="table-productos">
                <div class="table-header">
                    <h2>Inventario de Productos</h2>
                </div>
                <table id="collection-table-productos">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Marca</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Categoría</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Tabla de Servicios -->
            <div class="data-table" id="table-servicios">
                <div class="table-header">
                    <h2>Catálogo de Servicios</h2>
                </div>
                <table id="collection-table-servicios">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Duración</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Tabla de Usuarios -->
            <div class="data-table" id="table-usuarios">
                <div class="table-header">
                    <h2>Listado de Usuarios</h2>
                </div>
                <table id="collection-table-usuarios">
                    <thead>
                        <tr>
                            <td>Usuario</td>
                            <td>Nombre y apellido</td>
                            <td>Fecha De Nacimiento</td>
                            <td>Fecha De Registro</td>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            

            <!-- Modal Template -->
            <div id="modal-template" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title">Título del Modal</h2>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Los formularios se insertarán dinámicamente aquí -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary close-modal">Cancelar</button>
                        <button class="btn btn-primary save-modal">Guardar</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
// Variables globales
let currentView = 'inicio';
let citasChart = null;
let serviciosChart = null;

// Función para cargar la vista inicial
async function loadDashboardData() {
    try {
        const stats = await loadStats();
        updateStats(stats);
        const [serviciosData, ingresosData] = await Promise.all([
            fetch('/api/stats/servicios-populares').then(r => r.json()),
            fetch('/api/stats/ingresos-categoria').then(r => r.json())
        ]);
        updateCharts(serviciosData, ingresosData);
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar datos', 'error');
    }
}

// Función para cargar estadísticas
async function loadStats() {
    const response = await fetch('/api/stats/overview');
    return await response.json();
}

// Función para actualizar las estadísticas
function updateStats(stats) {
    document.getElementById('total-citas').textContent = stats.total_citas || 0;
    document.getElementById('total-clientes').textContent = stats.total_clientes || 0;
    document.getElementById('total-productos').textContent = stats.total_productos || 0;
    document.getElementById('total-servicios').textContent = stats.total_servicios || 0;
    document.getElementById('total-visitas').textContent = stats.total_visitas || 0;
}

// Función para actualizar las gráficas
function updateCharts(serviciosData, ingresosData) {
    // Limpiar gráficas existentes si existen
    if (citasChart) citasChart.destroy();
    if (serviciosChart) serviciosChart.destroy();

 // Gráfica de servicios populares
const serviciosCtx = document.getElementById('serviciosChart').getContext('2d');
serviciosChart = new Chart(serviciosCtx, {
    type: 'bar',
    data: {
        labels: serviciosData.map(s => s.nombre),
        datasets: [{
            label: 'Precio',
            data: serviciosData.map(s => s.precio),
            backgroundColor: 'rgba(255, 167, 38, 0.8)',
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                },
                ticks: {
                    callback: value => `Q${value}`,
                    color: '#2C3E50'  // Color oscuro para mejor visibilidad
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#2C3E50'  // Color oscuro para mejor visibilidad
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: true,
                text: 'Servicios más Solicitados',
                color: '#2C3E50',  // Color oscuro para mejor visibilidad
                font: {
                    size: 16,
                    family: "'Poppins', sans-serif"
                }
            }
        }
    }
});

// Gráfica de ingresos por categoría (Citas por Estado)
const ingresosCtx = document.getElementById('citasChart').getContext('2d');
citasChart = new Chart(ingresosCtx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(ingresosData),
        datasets: [{
            data: Object.values(ingresosData),
            backgroundColor: [
                'rgba(255, 167, 38, 0.8)',  // Naranja
                'rgba(46, 213, 115, 0.8)',  // Verde
                'rgba(33, 150, 243, 0.8)',  // Azul
                'rgba(233, 30, 99, 0.8)'    // Rosa
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#2C3E50',  // Color oscuro para mejor visibilidad
                    padding: 20,
                    font: {
                        size: 12,
                        family: "'Poppins', sans-serif"
                    }
                }
            },
            title: {
                display: true,
                text: 'Citas por Estado',
                color: '#2C3E50',  // Color oscuro para mejor visibilidad
                font: {
                    size: 16,
                    family: "'Poppins', sans-serif"
                }
            }
        }
    }
});
}

// Función para mostrar/ocultar tablas según la colección seleccionada
function toggleTables(collectionName) {
    const tables = ['citas', 'clientes', 'visitas', 'productos', 'servicios', 'usuarios'];
    tables.forEach(table => {
        const element = document.getElementById(`table-${table}`);
        if (element) {
            element.style.display = table === collectionName ? 'block' : 'none';
        }
    });
}

// Modificar la función updateTable para incluir los botones de acción
function updateTable(data, collectionName) {
    const tbody = document.querySelector(`#collection-table-${collectionName} tbody`);
    if (!tbody) return;

    tbody.innerHTML = '';
    data.forEach(item => {
        const row = document.createElement('tr');
        
        // Sanitizar el JSON para evitar problemas con comillas
        const safeItem = JSON.stringify(item).replace(/"/g, '&quot;');
        
        // Generar el contenido base de la fila según el tipo de colección
        let rowContent = getTableRow(item, collectionName);
        
        // Agregar botones de acción
        const actionButtons = `
            <td class="action-buttons">
                <button class="btn-icon btn-edit" onclick='handleEdit("${collectionName}", "${item.id}", ${safeItem})'>
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-delete" onclick='handleDelete("${collectionName}", "${item.id}")'>
                    <i class="fas fa-trash"></i>
                </button>
                ${collectionName === 'clientes' ? `
                    <button class="btn-icon btn-history" onclick='showClientHistory("${item.telefono}", "${item.nombre}")'>
                        <i class="fas fa-history"></i>
                    </button>
                ` : ''}
            </td>
        `;
        
        // Agregar el contenido completo a la fila
        row.innerHTML = `${rowContent}${actionButtons}`;
        tbody.appendChild(row);
    });
}

    
function getTableRow(item, collectionName) {
    switch (collectionName) {
        case 'citas':
            const serviciosStr = Array.isArray(item.servicios) ? 
                item.servicios.map(s => {
                    if (typeof s === 'object' && s !== null) {
                        return `${s.nombre} - Q${s.precio?.toFixed(2) || '0.00'}`;
                    }
                    return s;
                }).join('<br>') : 
                (item.servicios || '');

            return `
                <td>${item.cliente || ''}</td>
                <td>${item.telefono}</td>
                <td>${item.estilista}</td>
                <td>${serviciosStr}</td>
                <td><span class="status-badge status-${(item.estado || 'pendiente').toLowerCase()}">
                    ${item.estado || 'Pendiente'}</span></td>
                <td>${formatFirebaseDate(item.fecha)}</td>
                <td>Q${item.total?.toFixed(2) || '0.00'}</td>
            `;
        case 'visitas':
            const visistasserviciosStr = Array.isArray(item.servicios) ? 
                item.servicios.map(s => {
                    if (typeof s === 'object' && s !== null) {
                        return `${s.nombre} - Q${s.precio?.toFixed(2) || '0.00'}`;
                    }
                    return s;
                }).join('<br>') : 
                (item.servicios || '');

            return `
                <td>${item.visita || ''}</td>
                <td>${item.telefono}</td>
                <td>${item.estilista}</td>
                <td>${visistasserviciosStr}</td>
                <td><span class="status-badge status-${(item.estado || 'pendiente').toLowerCase()}">
                    ${item.estado || 'Pendiente'}</span></td>
                <td>${formatFirebaseDate(item.fecha)}</td>
                <td>Q${item.total?.toFixed(2) || '0.00'}</td>
            `;
        case 'clientes':
            return `
                <td>${item.nombre}</td>
                <td>${item.telefono}</td>
                <td>${item.email || 'N/A'}</td>
                <td>${item.nit || 'C/F'}</td>
                <td>${item.fecha_nacimiento ? formatDate(item.fecha_nacimiento) : 'N/A'}</td>
            `;
            
        case 'productos':
            const precio = parseFloat(item.precio) || 0;
            return `
                <td>${item.nombre || ''}</td>
                <td>${item.marca || ''}</td>
                <td>${item.stock || 0}</td>
                <td>Q${precio.toFixed(2)}</td>
                <td>${item.categoria || ''}</td>
            `;
            
        case 'servicios':
            return `
                <td>${item.nombre}</td>
                <td>${item.categoria}</td>
                <td>${item.duracion} min</td>
                <td>Q${item.precio.toFixed(2)}</td>
            `;
            
        case 'usuarios':
            return `
                <td>${item.username}</td>
                <td>${item.nombre} ${item.apellido}</td>
                <td>${item.fecha_nacimiento}</td>
                <td>${item.fecha_registro}</td>
            `;
            
        default:
            return '';
    }
}

function showClientHistory(telefono, nombre) {
    Swal.fire({
        title: 'Cargando historial...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    fetch(`/api/clientes/${telefono}/citas`)
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar el historial');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.error || 'Error al cargar el historial');

            const { cliente, estadisticas, citas } = data;
            
            const historialHTML = `
                <div class="historial-container">
                    <!-- Título con diseño elegante -->
                    <div class="historial-header">
                        <h2>Historial de ${cliente.nombre}</h2>
                    </div>
                    <!-- Estadísticas en cards elegantes -->
                    <div class="stats-row">
                        <div class="stat-item">
                            <i class="fas fa-calendar-check"></i>
                            <span class="stat-value">${estadisticas.total_citas}</span>
                            <span class="stat-label">Total Citas</span>
                        </div>
                        <div class="stat-item ${(estadisticas.citas_canceladas > 0) ? 'warning' : ''}">
                            <i class="fas fa-times-circle"></i>
                            <span class="stat-value">
                                ${(() => {
                                    console.log('Valor de citas_canceladas:', estadisticas.citas_canceladas);
                                    return Number(estadisticas.citas_canceladas || 0);
                                })()}
                            </span>
                            <span class="stat-label">Canceladas</span>
                        </div>
                        <div class="stat-item ${estadisticas.citas_pendientes > 0 ? 'pending' : ''}">
                            <i class="fas fa-clock"></i>
                            <span class="stat-value">${estadisticas.citas_pendientes}</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                        <div class="stat-item success">
                            <i class="fas fa-check-circle"></i>
                            <span class="stat-value">${estadisticas.citas_completadas}</span>
                            <span class="stat-label">Completadas</span>
                        </div>
                    </div>

                    <!-- Información financiera -->
                    <div class="financial-info">
                        <div class="finance-card">
                            <div class="amount">Q${estadisticas.total_gastado.toFixed(2)}</div>
                            <div class="label">Total Gastado</div>
                        </div>
                        <div class="finance-card">
                            <div class="amount">Q${estadisticas.promedio_gasto.toFixed(2)}</div>
                            <div class="label">Promedio por Visita</div>
                        </div>
                    </div>

                    <!-- Servicios Favoritos -->
                    <div class="favorites-section">
                        <h3><i class="fas fa-star"></i> Servicios Favoritos</h3>
                        <div class="favorites-list">
                            ${estadisticas.servicios_favoritos.map(s => `
                                <div class="favorite-item">
                                    <span>${s.nombre}</span>
                                    <span class="badge">${s.cantidad}x</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Tabla de historial -->
                    <div class="historial-table">
                        <h3>Detalle de Citas</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estilista</th>
                                        <th>Servicios</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${citas.map(cita => `
                                        <tr>
                                            <td>${cita.fecha_formateada}</td>
                                            <td>${cita.estilista?.nombre || 'Sin asignar'}</td>  <!-- Mostramos el nombre de la estilista -->
                                            <td class="servicios-lista">
                                                ${cita.servicios.map(servicio => `
                                                    <div class="servicio-item">
                                                        ${servicio.nombre}
                                                        <span class="precio">Q${servicio.precio.toFixed(2)}</span>
                                                    </div>
                                                `).join('')}
                                            </td>
                                            <td class="total">Q${cita.total.toFixed(2)}</td>
                                            <td>
                                                <span class="status-badge ${cita.estado.toLowerCase()}">${cita.estado}</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            Swal.fire({
                title: false,
                html: historialHTML,
                width: '90%',
                padding: '0',
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    container: 'historial-modal',
                    popup: 'historial-modal-popup',
                    content: 'historial-modal-content'
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo cargar el historial del cliente'
            });
        });
}

function setupClientesTable() {
    const table = document.querySelector('#collection-table-clientes');
    if (table) {
        const thead = table.querySelector('thead');
        if (thead) {
            thead.innerHTML = `
                <tr>
                    <th>Nombre</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>NIT</th>
                    <th>Fecha de Nacimiento</th>
                    <th>Acciones</th>
                </tr>
            `;
        }
    }
}


// Función auxiliar para formatear fechas
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-GT', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatFirebaseDate(dateString) {
    if (!dateString) return 'N/A';
    const [day, month, year] = dateString.split('/');
    return `${day}/${month}/${year}`;
}

// Nueva función para ocultar todas las tablas
function hideAllTables() {
    const tables = ['citas', 'clientes', 'visitas','productos', 'servicios', 'usuarios'];
    tables.forEach(table => {
        const element = document.getElementById(`table-${table}`);
        if (element) {
            element.style.display = 'none';
        }
    });
}

// Función para mostrar notificaciones
function showNotification(message, type) {
    // Implementar según necesidad (puede usar toastr.js o similar)
    alert(message);
}

// Función para agregar botones de acción a las tablas
function addActionButtons() {
    const tables = document.querySelectorAll('.data-table');
    tables.forEach(table => {
        // Agregar botón nuevo
        const header = table.querySelector('.table-header');
        const collection = table.id.replace('table-', '');
        const addButton = document.createElement('button');
        addButton.className = 'btn-add';
        addButton.innerHTML = '<i class="fas fa-plus"></i> Nuevo';
        addButton.onclick = () => handleNew(collection);
        header.appendChild(addButton);
        
        // Agregar columna de acciones a la tabla
        const thead = table.querySelector('thead tr');
        const actionsHeader = document.createElement('th');
        actionsHeader.textContent = 'Acciones';
        thead.appendChild(actionsHeader);
    });
}

// Handlers para las acciones CRUD
async function handleNew(collection) {
    try {
        let serviciosData;
        if (collection === 'citas' || collection === 'visitas') {
            serviciosData = await loadServicios();
        }     
        const formHTML = `<form>${generateForm(collection)}</form>`;
        const modalData = await showModal(`Nueva ${collection.slice(0, -1)}`, formHTML);
        
        // Procesar datos según la colección
        const data = { ...modalData };
        
        if (collection === 'citas') {
            // Parsear los servicios correctamente desde el JSON almacenado
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                    // Asegurarse de que cada servicio tenga la estructura correcta
                    data.servicios = data.servicios.map(servicio => ({
                        nombre: servicio.nombre,
                        precio: parseFloat(servicio.precio) || 0
                    }));
                } catch (e) {
                    console.error('Error al procesar servicios:', e);
                    data.servicios = [];
                }
            }
            
            // Formatear la fecha correctamente incluyendo hora
            if (data.fecha) {
                const fecha = new Date(data.fecha);
                if (!isNaN(fecha.getTime())) {
                    data.fecha = fecha.toLocaleString('es-GT', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            }
            
            // Asegurarse de que el total sea un número válido
            data.total = parseFloat(data.total) || 0;
            
            // Establecer estado por defecto si no está definido
            data.estado = data.estado || 'Pendiente';
            
            // Validar datos requeridos
            if (!data.cliente || !data.telefono || !data.fecha || data.servicios.length === 0) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
            
        } 

        else if (collection === 'visitas') {
            // Parsear los servicios correctamente desde el JSON almacenado
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                    // Asegurarse de que cada servicio tenga la estructura correcta
                    data.servicios = data.servicios.map(servicio => ({
                        nombre: servicio.nombre,
                        precio: parseFloat(servicio.precio) || 0
                    }));
                } catch (e) {
                    console.error('Error al procesar servicios:', e);
                    data.servicios = [];
                }
            }
            
            // Formatear la fecha correctamente incluyendo hora
            if (data.fecha) {
                const fecha = new Date(data.fecha);
                if (!isNaN(fecha.getTime())) {
                    data.fecha = fecha.toLocaleString('es-GT', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            }
            
            // Asegurarse de que el total sea un número válido
            data.total = parseFloat(data.total) || 0;
            
            // Establecer estado por defecto si no está definido
            data.estado = data.estado || 'Pendiente';
            
            // Validar datos requeridos
            if (!data.visita || !data.telefono || !data.fecha || data.servicios.length === 0) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
            
        } 
        else if (collection === 'productos') {
            // Procesar datos de productos
            data.precio = parseFloat(data.precio) || 0;
            data.stock = parseInt(data.stock) || 0;
            
            // Validar datos requeridos
            if (!data.nombre || !data.marca || !data.categoria) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
            
        } else if (collection === 'servicios') {
            // Procesar datos de servicios
            data.precio = parseFloat(data.precio) || 0;
            data.duracion = parseInt(data.duracion) || 0;
            data.disponible = !!data.disponible;
            
            // Validar datos requeridos
            if (!data.nombre || !data.categoria || !data.duracion) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
            
        } else if (collection === 'clientes') {
             // Validar datos de clientes
             if (!data.nombre || !data.telefono) {
                throw new Error('Por favor complete los campos requeridos');
            }
            
            // Formatear campos opcionales
            data.email = data.email || null;
            data.nit = data.nit || 'C/F';
            data.fecha_nacimiento = data.fecha_nacimiento || null;

            // Si hay fecha de nacimiento, asegurarse de que esté en el formato correcto
            if (data.fecha_nacimiento) {
                const fecha = new Date(data.fecha_nacimiento);
                if (!isNaN(fecha.getTime())) {
                    data.fecha_nacimiento = fecha.toISOString().split('T')[0];
                }
            }
            
        } else if (collection === 'usuarios') {
            // Validar datos de usuarios
            if (!data.username || !data.password || !data.nombre || !data.apellido || !data.fecha_nacimiento) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
            
            // Agregar fecha de registro
            data.fecha_registro = new Date().toISOString();
        }
        
        console.log('Datos a enviar:', data);

        const response = await fetch(`/api/collection/${collection}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Error al crear el registro');
        }

        const result = await response.json();

        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Registro Creado',
                text: 'El registro ha sido creado exitosamente'
            });

            await handleNavigation(collection);
        } else {
            throw new Error(result.error || 'Error al crear el registro');
        }

    } catch (error) {
        console.error('Error processing record:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Error al crear el registro'
        });
    }
}

const formConfigs = {
    clientes: [
        { name: 'nombre', label: 'Nombre', type: 'text', required: true },
        { name: 'telefono', label: 'Teléfono', type: 'tel', required: true },
        { name: 'email', label: 'Email', type: 'email', required: false },
        { name: 'nit', label: 'NIT', type: 'text', required: false },
        { name: 'fecha_nacimiento', label: 'Fecha de Nacimiento', type: 'date', required: false }
    ],
    servicios: [
        { name: 'nombre', label: 'Nombre', type: 'text', required: true },
        { name: 'categoria', label: 'Categoría', type: 'text', required: true },
        { name: 'duracion', label: 'Duración (min)', type: 'number', required: true },
        { name: 'precio', label: 'Precio', type: 'number', required: true }
    ],
    productos: [
        { name: 'nombre', label: 'Nombre', type: 'text', required: true },
        { name: 'marca', label: 'Marca', type: 'text', required: true },
        { name: 'stock', label: 'Stock', type: 'number', required: true },
        { name: 'precio', label: 'Precio', type: 'number', required: true },
        { name: 'categoria', label: 'Categoría', type: 'text', required: true }
    ],
    citas: [
        { name: 'cliente', label: 'Cliente', type: 'text', required: true },
        { name: 'telefono', label: 'Teléfono', type: 'tel', required: true },
        { name: 'estilista', label: 'Estilista', type: 'text', required: true },
        { 
            name: 'servicios', 
            label: 'Servicios', 
            type: 'service-selector',
            required: true,
            options: [] // Este array se llenará con loadServicios
        },
        { name: 'fecha', label: 'Fecha', type: 'datetime-local', required: true },
        { name: 'notas', label: 'Notas', type: 'textarea', required: false },
        { 
            name: 'estado', 
            label: 'Estado', 
            type: 'select', 
            required: true,
            options: ['Pendiente', 'Cancelada', 'Completada']
        }
    ],
    visitas: [
        { name: 'visita', label: 'Visita', type: 'text', required: true },
        { name: 'telefono', label: 'Teléfono', type: 'tel', required: true },
        { name: 'estilista', label: 'Estilista', type: 'text', required: true },
        { 
            name: 'servicios', 
            label: 'Servicios', 
            type: 'service-selector',
            required: true,
            options: [] // Este array se llenará con loadServicios
        },
        { name: 'fecha', label: 'Fecha', type: 'datetime-local', required: true },
        { name: 'notas', label: 'Notas', type: 'textarea', required: false },
        { 
            name: 'estado', 
            label: 'Estado', 
            type: 'select', 
            required: true,
            options: ['Cancelada', 'Completada']
        }
    ],
    usuarios: [
        { name: 'username', label: 'Usuario', type: 'text', required: true },
        { name: 'password', label: 'Contraseña', type: 'password', required: true },
        { name: 'nombre', label: 'Nombre', type: 'text', required: true },
        { name: 'apellido', label: 'Apellido', type: 'text', required: true },
        { name: 'fecha_nacimiento', label: 'Fecha de Nacimiento', type: 'date', required: true }
    ]
};

// Función para generar formulario dinámico
function generateForm(collection, data = null) {
    const config = formConfigs[collection];
    let formHTML = '';
    
    config.forEach(field => {
        if (field.name === 'total' && collection === 'citas' && collection === 'visitas') return;
        
        const value = data ? data[field.name] : '';
        formHTML += `<div class="form-group">
            <label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>`;
            
        if (field.type === 'service-selector') {
            const serviciosValue = value ? 
                (typeof value === 'string' ? value : JSON.stringify(value)) : 
                '[]';
                    
            formHTML += `
                <div class="service-selector">
                    <select class="form-control" id="servicio-dropdown">
                        <option value="">Seleccionar servicio</option>
                        ${field.options.map(service => `
                            <option value="${service.nombre}" data-precio="${service.precio}">
                                ${service.nombre} - Q${service.precio.toFixed(2)}
                            </option>
                        `).join('')}
                    </select>
                    <button type="button" class="btn btn-primary" id="agregar-servicio">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                    <div class="selected-services">
                        <ul class="services-list"></ul>
                    </div>
                    <input type="hidden" id="servicios" name="servicios" value='${serviciosValue}'>
                    <div class="form-group">
                        <label for="total">Total</label>
                        <input type="number" class="form-control total-field" 
                            id="total" name="total" value="${data?.total || 0}" readonly>
                    </div>
                </div>`;
        } else if (field.type === 'textarea') {
            formHTML += `
                <textarea class="form-control" 
                    id="${field.name}" 
                    name="${field.name}" 
                    rows="3"
                    ${field.required ? 'required' : ''}>${value || ''}</textarea>`;
        } else if (field.type === 'select') {
            formHTML += `
                <select class="form-control" 
                    id="${field.name}" 
                    name="${field.name}"
                    ${field.required ? 'required' : ''}>
                    ${field.options.map(opt => `
                        <option value="${opt}" ${value === opt ? 'selected' : ''}>
                            ${opt}
                        </option>
                    `).join('')}
                </select>`;
        } else if (field.type === 'datetime-local') {
            formHTML += `
                <input type="datetime-local" 
                    class="form-control" 
                    id="${field.name}" 
                    name="${field.name}" 
                    ${field.required ? 'required' : ''}
                    step="60" 
                    value="${value || ''}">`;
        } else {
            formHTML += `
                <input type="${field.type}" 
                    class="form-control" 
                    id="${field.name}" 
                    name="${field.name}" 
                    ${field.required ? 'required' : ''} 
                    ${field.readonly ? 'readonly' : ''}
                    value="${value || ''}">`;
        }
        
        formHTML += '</div>';
    });
    
    return formHTML;
}

async function handleSaveCita(data) {
    // Asegurarse de que la fecha incluya la hora
    if (data.fecha) {
        const fechaObj = new Date(data.fecha);
        if (!isNaN(fechaObj.getTime())) {
            data.fecha = fechaObj.toLocaleString('es-GT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
    }
    
    // Asegurarse de que los servicios sean un array de objetos
    if (typeof data.servicios === 'string') {
        try {
            data.servicios = JSON.parse(data.servicios);
        } catch (e) {
            data.servicios = [];
        }
    }
    
    // Asegurarse de que el total sea un número
    data.total = parseFloat(data.total) || 0;
    
    return data;
}

// Función para mostrar modal
function showModal(title, content) {
    const modal = document.getElementById('modal-template');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = modal.querySelector('.modal-body');
    
    modalTitle.textContent = title;
    modalBody.innerHTML = content;
    modal.style.display = 'block';
    
    // Inicializar el selector de servicios si estamos en el formulario de citas
    if (content.includes('service-selector')) {
        initializeServiceSelector();
    }
    
    return new Promise((resolve, reject) => {
        const saveBtn = modal.querySelector('.save-modal');
        const closeBtns = modal.querySelectorAll('.close, .close-modal');
        
        saveBtn.onclick = () => {
            const formData = new FormData(modalBody.querySelector('form'));
            const data = Object.fromEntries(formData);
            if (data.servicios) {
                try {
                    data.servicios = JSON.parse(data.servicios);
                } catch (e) {
                    data.servicios = data.servicios.split(',');
                }
            }
            modal.style.display = 'none';
            resolve(data);
        };
        
        closeBtns.forEach(btn => {
            btn.onclick = () => {
                modal.style.display = 'none';
                reject('Modal closed');
            };
        });
    });
}

function initializeServiceSelector() {
    const dropdown = document.getElementById('servicio-dropdown');
    const addButton = document.getElementById('agregar-servicio');
    const servicesList = document.querySelector('.services-list');
    const serviciosInput = document.getElementById('servicios');
    const totalInput = document.getElementById('total');
    let selectedServices = [];
    let total = 0;

    // Cargar servicios existentes si hay
    try {
        const existingServices = serviciosInput.value;
        if (existingServices) {
            // Intentar diferentes formatos de datos
            if (typeof existingServices === 'string') {
                if (existingServices.startsWith('[')) {
                    // Es un string JSON
                    selectedServices = JSON.parse(existingServices);
                } else {
                    // Podría ser otro formato, intentar dividir
                    selectedServices = existingServices.split(',').map(s => {
                        const parts = s.split('-');
                        return {
                            nombre: parts[0].trim(),
                            precio: parseFloat(parts[1]?.replace(/[^0-9.]/g, '') || 0)
                        };
                    });
                }
            } else if (Array.isArray(existingServices)) {
                // Ya es un array
                selectedServices = existingServices;
            }
            
            // Asegurarse de que cada servicio tenga el formato correcto
            selectedServices = selectedServices.map(s => ({
                nombre: s.nombre || '',
                precio: parseFloat(s.precio || 0)
            }));

            renderServicesList();
        }
    } catch (e) {
        console.error('Error parsing existing services:', e);
        selectedServices = [];
    }

    function renderServicesList() {
        if (!servicesList) return;

        servicesList.innerHTML = selectedServices.map((service, index) => `
            <div class="service-item">
                ${service.nombre} - Q${parseFloat(service.precio).toFixed(2)}
                <button type="button" class="btn-remove" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');

        updateTotal();

        // Actualizar el input oculto
        if (serviciosInput) {
            serviciosInput.value = JSON.stringify(selectedServices);
        }

        // Agregar event listeners a los botones de eliminar
        document.querySelectorAll('.btn-remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                if (!isNaN(index) && index >= 0 && index < selectedServices.length) {
                    total -= parseFloat(selectedServices[index].precio) || 0;
                    selectedServices.splice(index, 1);
                    renderServicesList();
                }
            });
        });
    }

    // Event listener para agregar servicios
    addButton?.addEventListener('click', () => {
        if (!dropdown?.selectedOptions[0]) return;
        
        const servicio = {
            nombre: dropdown.selectedOptions[0].value,
            precio: parseFloat(dropdown.selectedOptions[0].dataset.precio) || 0
        };

        // Evitar duplicados
        if (!selectedServices.some(s => s.nombre === servicio.nombre)) {
            selectedServices.push(servicio);
            total += servicio.precio;
            renderServicesList();
        }
    });

    function updateTotal() {
        total = selectedServices.reduce((sum, service) => {
            return sum + (parseFloat(service.precio) || 0);
        }, 0);

        if (totalInput) {
            totalInput.value = total.toFixed(2);
        }

        // Actualizar cualquier campo de total adicional
        const totalDisplay = document.querySelector('input[name="total"]');
        if (totalDisplay) {
            totalDisplay.value = total.toFixed(2);
            totalDisplay.classList.add('total-field');
            totalDisplay.readOnly = true;
        }
    }

    // Renderizar lista inicial si hay servicios
    if (selectedServices.length > 0) {
        renderServicesList();
    }
}

async function handleEdit(collection, id, currentData) {
    try {
        let data;

        if (collection === 'citas') {
            const servicios = await loadServicios();
            
            // Preparar los datos existentes
            const formData = {
                cliente: currentData.cliente,
                telefono: currentData.telefono,
                estilista: currentData.estilista,
                fecha: currentData.fecha,
                notas: currentData.notas,
                estado: currentData.estado,
                servicios: Array.isArray(currentData.servicios) ? 
                    currentData.servicios : 
                    typeof currentData.servicios === 'string' ? 
                        JSON.parse(currentData.servicios) : [],
                total: currentData.total || 0
            };

            // Formatear la fecha para el input datetime-local
            if (formData.fecha) {
                const [datePart, timePart] = formData.fecha.split(', ');
                const [day, month, year] = datePart.split('/');
                const time = timePart || '00:00';
                formData.fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`;
            }

            // Asegurarse de que servicios sea un array válido
            if (!Array.isArray(formData.servicios)) {
                formData.servicios = [];
            }

            const formHTML = `<form>${generateForm(collection, formData)}</form>`;
            
            // Mostrar el modal
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);

            // Asegurarse que los servicios se mantienen como array después del modal
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                } catch (e) {
                    console.error('Error parsing servicios:', e);
                    data.servicios = [];
                }
            }

            // Inicializar el selector de servicios
            setTimeout(() => {
                const servicesList = document.querySelector('.services-list');
                const serviciosInput = document.getElementById('servicios');
                const totalInput = document.getElementById('total');
                const dropdown = document.getElementById('servicio-dropdown');
                const addButton = document.getElementById('agregar-servicio');
                
                let selectedServices = [];
                
                // Cargar servicios existentes
                try {
                    selectedServices = currentData.servicios || [];
                    renderServicesList();
                } catch (e) {
                    console.error('Error loading existing services:', e);
                }

                function renderServicesList() {
                    servicesList.innerHTML = selectedServices.map((service, index) => `
                        <div class="service-item">
                            ${service.nombre} - Q${parseFloat(service.precio).toFixed(2)}
                            <button type="button" class="btn-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('');

                    // Actualizar el total
                    const total = selectedServices.reduce((sum, service) => sum + parseFloat(service.precio), 0);
                    totalInput.value = total.toFixed(2);

                    // Actualizar el input oculto
                    serviciosInput.value = JSON.stringify(selectedServices);

                    // Agregar event listeners a los botones de eliminar
                    document.querySelectorAll('.btn-remove').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(btn.dataset.index);
                            selectedServices.splice(index, 1);
                            renderServicesList();
                        });
                    });
                }

                // Event listener para agregar servicios
                addButton?.addEventListener('click', () => {
                    const selected = dropdown.options[dropdown.selectedIndex];
                    if (!selected.value) return;

                    const servicio = {
                        nombre: selected.value,
                        precio: parseFloat(selected.dataset.precio) || 0
                    };

                    // Evitar duplicados
                    if (!selectedServices.some(s => s.nombre === servicio.nombre)) {
                        selectedServices.push(servicio);
                        renderServicesList();
                    }
                });
            }, 100);

            // Asegurar que los servicios se mantengan como array de objetos
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                } catch (e) {
                    console.error('Error parsing servicios:', e);
                    data.servicios = [];
                }
            }

            // Actualizar el total
            data.total = parseFloat(data.total) || 0;

            // Si hay fecha, formatearla correctamente
            if (data.fecha) {
                const fechaObj = new Date(data.fecha);
                if (!isNaN(fechaObj.getTime())) {
                    data.fecha = fechaObj.toLocaleString('es-GT', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            }

            // Validar datos requeridos
            if (!data.cliente || !data.telefono || !data.fecha || (data.servicios && !data.servicios.length)) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
        } 
        

        else if (collection === 'visitas') {
            const servicios = await loadServicios();
            
            // Preparar los datos existentes
            const formData = {
                visita: currentData.visita,
                telefono: currentData.telefono,
                estilista: currentData.estilista,
                fecha: currentData.fecha,
                notas: currentData.notas,
                estado: currentData.estado,
                servicios: Array.isArray(currentData.servicios) ? 
                    currentData.servicios : 
                    typeof currentData.servicios === 'string' ? 
                        JSON.parse(currentData.servicios) : [],
                total: currentData.total || 0
            };

            // Formatear la fecha para el input datetime-local
            if (formData.fecha) {
                const [datePart, timePart] = formData.fecha.split(', ');
                const [day, month, year] = datePart.split('/');
                const time = timePart || '00:00';
                formData.fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`;
            }

            // Asegurarse de que servicios sea un array válido
            if (!Array.isArray(formData.servicios)) {
                formData.servicios = [];
            }

            const formHTML = `<form>${generateForm(collection, formData)}</form>`;
            
            // Mostrar el modal
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);

            // Asegurarse que los servicios se mantienen como array después del modal
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                } catch (e) {
                    console.error('Error parsing servicios:', e);
                    data.servicios = [];
                }
            }

            // Inicializar el selector de servicios
            setTimeout(() => {
                const servicesList = document.querySelector('.services-list');
                const serviciosInput = document.getElementById('servicios');
                const totalInput = document.getElementById('total');
                const dropdown = document.getElementById('servicio-dropdown');
                const addButton = document.getElementById('agregar-servicio');
                
                let selectedServices = [];
                
                // Cargar servicios existentes
                try {
                    selectedServices = currentData.servicios || [];
                    renderServicesList();
                } catch (e) {
                    console.error('Error loading existing services:', e);
                }

                function renderServicesList() {
                    servicesList.innerHTML = selectedServices.map((service, index) => `
                        <div class="service-item">
                            ${service.nombre} - Q${parseFloat(service.precio).toFixed(2)}
                            <button type="button" class="btn-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('');

                    // Actualizar el total
                    const total = selectedServices.reduce((sum, service) => sum + parseFloat(service.precio), 0);
                    totalInput.value = total.toFixed(2);

                    // Actualizar el input oculto
                    serviciosInput.value = JSON.stringify(selectedServices);

                    // Agregar event listeners a los botones de eliminar
                    document.querySelectorAll('.btn-remove').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(btn.dataset.index);
                            selectedServices.splice(index, 1);
                            renderServicesList();
                        });
                    });
                }

                // Event listener para agregar servicios
                addButton?.addEventListener('click', () => {
                    const selected = dropdown.options[dropdown.selectedIndex];
                    if (!selected.value) return;

                    const servicio = {
                        nombre: selected.value,
                        precio: parseFloat(selected.dataset.precio) || 0
                    };

                    // Evitar duplicados
                    if (!selectedServices.some(s => s.nombre === servicio.nombre)) {
                        selectedServices.push(servicio);
                        renderServicesList();
                    }
                });
            }, 100);

            // Asegurar que los servicios se mantengan como array de objetos
            if (typeof data.servicios === 'string') {
                try {
                    data.servicios = JSON.parse(data.servicios);
                } catch (e) {
                    console.error('Error parsing servicios:', e);
                    data.servicios = [];
                }
            }

            // Actualizar el total
            data.total = parseFloat(data.total) || 0;

            // Si hay fecha, formatearla correctamente
            if (data.fecha) {
                const fechaObj = new Date(data.fecha);
                if (!isNaN(fechaObj.getTime())) {
                    data.fecha = fechaObj.toLocaleString('es-GT', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            }

            // Validar datos requeridos
            if (!data.visita || !data.telefono || !data.fecha || (data.servicios && !data.servicios.length)) {
                throw new Error('Por favor complete todos los campos requeridos');
            }
        }

        else if (collection === 'clientes') {
            // Validar datos de cliente
            if (currentData.fecha_nacimiento) {
                const fecha = new Date(currentData.fecha_nacimiento);
                if (!isNaN(fecha.getTime())) {
                    currentData.fecha_nacimiento = fecha.toISOString().split('T')[0];
                }
            }
            
            const formHTML = `<form>${generateForm(collection, currentData)}</form>`;
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);
            
            // Validar datos requeridos
            if (!data.nombre || !data.telefono) {
                throw new Error('El nombre y teléfono son obligatorios');
            }
            
            // Formatear campos opcionales
            data.email = data.email || null;
            data.nit = data.nit || 'C/F';
            data.fecha_nacimiento = data.fecha_nacimiento || null;

        } else if (collection === 'productos') {
            const formHTML = `<form>${generateForm(collection, currentData)}</form>`;
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);
            
            data.precio = parseFloat(data.precio);
            data.stock = parseInt(data.stock);

        } else if (collection === 'servicios') {
            const formHTML = `<form>${generateForm(collection, currentData)}</form>`;
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);
            
            data.precio = parseFloat(data.precio);
            data.duracion = parseInt(data.duracion);

        } else if (collection === 'usuarios') {
            const formHTML = `<form>${generateForm(collection, currentData)}</form>`;
            data = await showModal(`Editar ${collection.slice(0, -1)}`, formHTML);
            
            if (!data.username || !data.nombre || !data.apellido) {
                throw new Error('Todos los campos son obligatorios');
            }
        }

        // Realizar la petición al servidor
        const response = await fetch(`/api/collection/${collection}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Error al actualizar el registro');
        }

        const result = await response.json();
        
        if (result.success) {
            await Swal.fire({
                icon: 'success',
                title: 'Actualizado',
                text: 'El registro ha sido actualizado exitosamente'
            });

            await handleNavigation(collection);
        } else {
            throw new Error(result.error || 'Error al actualizar el registro');
        }
        
    } catch (error) {
        if (error !== 'Modal closed') {
            console.error('Error al actualizar:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Error al actualizar el registro'
            });
        }
    }
}

async function loadServicios() {
    try {
        const response = await fetch('/api/collection/servicios');
        if (!response.ok) throw new Error('Error cargando servicios');
        const data = await response.json();
        
        // Actualizar las opciones en formConfigs
        const serviciosConfig = formConfigs.citas.find(f => f.name === 'servicios');
        const visitasServiciosConfig = formConfigs.visitas.find(f => f.name === 'servicios');
        if (serviciosConfig) {
            serviciosConfig.options = data.data.map(s => ({
                nombre: s.nombre || s.categoria,
                precio: parseFloat(s.precio || 0)
            }));
        }

        if (visitasServiciosConfig) {
            visitasServiciosConfig.options = data.data.map(s => ({
                nombre: s.nombre || s.categoria, 
                precio: parseFloat(s.precio || 0)
            }));
        }
        // Actualizar el dropdown si existe
        const dropdown = document.getElementById('servicio-dropdown');
        if (dropdown) {
            dropdown.innerHTML = `
                <option value="">Seleccionar servicio</option>
                ${data.data.map(servicio => `
                    <option value="${servicio.nombre}" data-precio="${servicio.precio}">
                        ${servicio.nombre} - Q${servicio.precio.toFixed(2)}
                    </option>
                `).join('')}
            `;
        }
            
        return data;
    } catch (error) {
        console.error('Error:', error);
        throw error;
    }
}

async function handleDelete(collection, id) {
    try {
        // Primero mostramos el diálogo de confirmación
        const confirmResult = await Swal.fire({
            title: '¿Está seguro?',
            text: "¿Desea eliminar este registro?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        // Si el usuario confirmó, procedemos con la eliminación
        if (confirmResult.isConfirmed) {
            const response = await fetch(`/api/collection/${collection}/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Error al eliminar registro');
            }

            // Si todo salió bien, mostramos el mensaje de éxito
            await Swal.fire({
                icon: 'success',
                title: 'Eliminado',
                text: 'El registro ha sido eliminado exitosamente'
            });

            // Actualizamos la navegación
            await handleNavigation(collection);
            
        }
    } catch (error) {
        console.error('Error deleting record:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Error al eliminar el registro'
        });
    }
}

function modifyNewCitaForm() {
    const clienteField = document.querySelector('.form-group input[name="cliente"]');
    if (clienteField) {
        const parentDiv = clienteField.parentElement;
        parentDiv.innerHTML = `
            <label for="cliente">Cliente</label>
            <div class="client-search-container">
                <input type="text" 
                    class="form-control" 
                    name="cliente" 
                    id="cliente" 
                    placeholder="Buscar cliente..." 
                    autocomplete="off"
                    required>
                <div class="client-results" style="display: none;"></div>
            </div>
            <input type="hidden" name="cliente_id" id="cliente_id">
        `;

        const clienteInput = document.getElementById('cliente');
        const resultsDiv = document.querySelector('.client-results');
        
        clienteInput.addEventListener('input', debounce(async (e) => {
            const searchTerm = e.target.value;
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/clientes/buscar?q=${searchTerm}`);
                const data = await response.json();
                
                if (data.success && data.clientes.length > 0) {
                    resultsDiv.innerHTML = data.clientes.map(cliente => `
                        <div class="client-result-item" 
                            data-id="${cliente.id}"
                            data-nombre="${cliente.nombre}"
                            data-telefono="${cliente.telefono}">
                            <div class="client-info">
                                <span class="client-name">${cliente.nombre}</span>
                                <span class="client-phone">${cliente.telefono}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    resultsDiv.style.display = 'block';

                    // Agregar eventos click a los resultados
                    document.querySelectorAll('.client-result-item').forEach(item => {
                        item.addEventListener('click', () => {
                            clienteInput.value = item.dataset.nombre;
                            document.getElementById('cliente_id').value = item.dataset.id;
                            document.getElementById('telefono').value = item.dataset.telefono;
                            resultsDiv.style.display = 'none';
                        });
                    });
                } else {
                    resultsDiv.innerHTML = '<div class="no-results">No se encontraron clientes</div>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error en la búsqueda:', error);
            }
        }, 300));

        // Cerrar resultados al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.client-search-container')) {
                resultsDiv.style.display = 'none';
            }
        });
    }
}

// Función para manejar la navegación
function handleNavigation(collection) {
    // Actualizar vista actual
    currentView = collection || 'inicio';

    // Mostrar/ocultar elementos según la vista
    const chartsGrid = document.querySelector('.charts-grid');
    
    if (currentView === 'inicio') {
        // En inicio: mostrar gráficas y ocultar todas las tablas
        chartsGrid.style.display = 'grid';
        hideAllTables();
        loadDashboardData();
    } else {
        // En otras vistas: ocultar gráficas y mostrar solo la tabla correspondiente
        chartsGrid.style.display = 'none';
        hideAllTables();  // Primero ocultamos todas las tablas
        toggleTables(collection); // Luego mostramos solo la tabla necesaria
        
// Cargar datos de la colección específica
fetch(`/api/collection/${collection}`)
   .then(response => {
       if (!response.ok) {
           throw new Error(`HTTP error! status: ${response.status}`);
       }
       return response.json();
   })
   .then(data => {
       if (!data || !data.data) {
           throw new Error('Datos inválidos recibidos del servidor');
       }
       console.log('Datos recibidos:', data); // Ver estructura de datos
       updateTable(data.data, collection);
   })
   .catch(error => {
       console.error('Error detallado:', error);
       console.error('Stack trace:', error.stack);
       showNotification(`Error al cargar datos: ${error.message}`, 'error');
       
       if (error.name === 'TypeError') {
           console.error('Error de tipo - Revisa el formato de los datos');
       }
       if (error.name === 'SyntaxError') {
           console.error('Error de sintaxis JSON - Respuesta malformada');
       }
   });
    }
}


// Agregar el HTML para la barra de búsqueda y filtros al inicio de cada tabla
function addSearchAndFilters() {
    const tables = document.querySelectorAll('.data-table');
    
    tables.forEach(table => {
        const collection = table.id.replace('table-', '');
        const header = table.querySelector('.table-header');
        
        // Verificar si ya existe un contenedor de búsqueda
        const existingContainer = header.querySelector('.search-filter-container');
        if (existingContainer) {
            existingContainer.remove();
        }
        
        const searchContainer = document.createElement('div');
        searchContainer.className = 'search-filter-container';
        const filterOptions = getFilterOptions(collection);
        
        searchContainer.innerHTML = `
            <div class="search-filters-wrapper">
                <div class="search-box">
                    <input type="text" 
                        class="search-input" 
                        placeholder="Buscar ${collection}..."
                        data-collection="${collection}">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="filters-box">
                    ${filterOptions}
                </div>
            </div>
        `;
        
        // Insertar después del h2 pero antes del botón de agregar
        const title = header.querySelector('h2');
        if (title && title.nextSibling) {
            header.insertBefore(searchContainer, title.nextSibling);
        } else {
            header.appendChild(searchContainer);
        }
    });
    
    initializeSearchAndFilters();
}

// Obtener las opciones de filtro según la colección
function getFilterOptions(collection) {
    switch (collection) {
        case 'citas':
            return `
                <select class="filter-select" data-filter="estado">
                    <option value="">Estado</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="completada">Completada</option>
                    <option value="cancelada">Cancelada</option>
                </select>
                <div class="date-filter-container">
                    <input type="date" 
                        class="filter-date" 
                        data-filter="fecha" 
                        placeholder="Seleccionar fecha">
                </div>
            `;
        case 'visitas':
            return `
                <select class="filter-select" data-filter="estado">
                    <option value="">Estado</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="completada">Completada</option>
                    <option value="cancelada">Cancelada</option>
                </select>
                <div class="date-filter-container">
                    <input type="date" 
                        class="filter-date" 
                        data-filter="fecha" 
                        placeholder="Seleccionar fecha">
                </div>
            `;
        case 'productos':
            return `
                <select class="filter-select" data-filter="stock">
                    <option value="">Stock</option>
                    <option value="bajo">Stock bajo</option>
                    <option value="alto">Stock alto</option>
                </select>
            `;
            
        case 'servicios':
            return `
                <select class="filter-select" data-filter="duracion">
                    <option value="">Duración</option>
                    <option value="corta">Corta (< 30 min)</option>
                    <option value="media">Media (30-60 min)</option>
                    <option value="larga">Larga (> 60 min)</option>
                </select>
            `;

            
        default:
            return '';
    }
}

// Inicializar la funcionalidad de búsqueda y filtros
function initializeSearchAndFilters() {
    // Event listener para búsqueda
    document.querySelectorAll('.search-input').forEach(input => {
        input.addEventListener('input', debounce(handleSearch, 300));
    });
    
    // Event listener para filtros
    document.querySelectorAll('.filter-select, .filter-date').forEach(filter => {
        filter.addEventListener('change', handleFilter);
    });
}

// Función para manejar la búsqueda
async function handleSearch(event) {
    const searchTerm = event.target.value.toLowerCase();
    const collection = event.target.dataset.collection;
    const tbody = document.querySelector(`#collection-table-${collection} tbody`);
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const match = text.includes(searchTerm);
        row.style.display = match ? '' : 'none';
    });
}

// Función para manejar los filtros
async function handleFilter(event) {
    const filterType = event.target.dataset.filter;
    const filterValue = event.target.value;
    const collection = event.target.closest('.data-table').id.replace('table-', '');
    const tbody = document.querySelector(`#collection-table-${collection} tbody`);
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        let show = true;
        
        switch (filterType) {
            case 'estado':
                const estadoBadge = row.querySelector('.status-badge');
                if (estadoBadge) {
                    const estadoActual = estadoBadge.textContent.trim().toLowerCase();
                    switch (filterValue.toLowerCase()) {
                        case 'pendiente':
                            show = estadoActual === 'pendiente';
                            break;
                        case 'completada':
                            show = estadoActual === 'completada';
                            break;
                        case 'cancelada':
                            show = estadoActual === 'cancelada';
                            break;
                        default:
                            show = true; // Si no hay filtro seleccionado, mostrar todo
                    }
                }
                break;
                
            case 'categoria':
                const categoria = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
                show = !filterValue || categoria === filterValue;
                break;
                
            case 'stock':
                const stock = parseInt(row.querySelector('td:nth-child(3)')?.textContent);
                switch (filterValue) {
                    case 'bajo':
                        show = stock <= 10;
                        break;
                    case 'normal':
                        show = stock > 10 && stock <= 50;
                        break;
                    case 'alto':
                        show = stock > 50;
                        break;
                }
                break;
            case 'duracion':
                const duracion = parseInt(row.querySelector('td:nth-child(3)')?.textContent);
                switch (filterValue) {
                    case 'corta':
                        show = duracion <= 30;
                        break;
                    case 'media':
                        show = duracion > 30 && duracion <= 60;
                        break;
                    case 'larga':
                        show = duracion > 60;
                        break;
                }
                break;
            case 'fecha':
                if (filterValue) {
                    const fechaTexto = row.querySelector('td:nth-child(6)')?.textContent;
                    if (fechaTexto) {
                        // Convertir la fecha del filtro de YYYY-MM-DD a DD/MM/YYYY
                        const [yearFiltro, monthFiltro, dayFiltro] = filterValue.split('-');
                        const fechaFiltroFormatted = `${dayFiltro}/${monthFiltro}/${yearFiltro}`;
                        
                        // Obtener solo la fecha del texto de la tabla "DD/MM/YYYY, HH:mm"
                        const fechaTablaBase = fechaTexto.split(',')[0];  // Obtiene "DD/MM/YYYY"
                        
                        // Comparar directamente los strings de fecha
                        show = fechaTablaBase === fechaFiltroFormatted;
                    } else {
                        show = false;
                    }
                }
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function parseFechaPersonalizada(fechaStr) {
    if (!fechaStr) return null;
    
    try {
        // Separar la fecha y la hora
        const [fecha, hora] = fechaStr.split(', ');
        
        if (!fecha) return null;
        
        // Separar día, mes y año
        const [dia, mes, anio] = fecha.split('/');
        
        // Separar horas y minutos si existen
        let horas = 0, minutos = 0;
        if (hora) {
            [horas, minutos] = hora.split(':').map(num => parseInt(num, 10));
        }
        
        // Crear el objeto Date (recordar que los meses en JavaScript van de 0 a 11)
        const fechaObj = new Date(
            parseInt(anio, 10),
            parseInt(mes, 10) - 1,
            parseInt(dia, 10),
            horas,
            minutos
        );
        
        // Verificar si la fecha es válida
        if (isNaN(fechaObj.getTime())) {
            return null;
        }
        
        return fechaObj;
    } catch (error) {
        console.error('Error al parsear la fecha:', error);
        return null;
    }
}


// Función debounce para optimizar la búsqueda
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Inicialización cuando el DOM está listo
document.addEventListener('DOMContentLoaded', () => {
    // Cargar datos iniciales y ocultar todas las tablas
    loadDashboardData();
    hideAllTables();
    addActionButtons();
    setupClientesTable();
    addSearchAndFilters();

    // Manejar navegación
    document.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            
            // Actualizar clase activa
            const prevActive = document.querySelector('.menu-link.active');
            prevActive?.classList.remove('active');
            link.classList.add('active');

            // Manejar navegación
            const collection = link.dataset.collection;
            handleNavigation(collection);

            const btnNewCita = document.querySelector('[data-collection="citas"] .btn-add');
            if (btnNewCita) {
                const originalClick = btnNewCita.onclick;
                btnNewCita.onclick = async () => {
                    await originalClick();
                    modifyNewCitaForm();
                };
            }
        });
    });
});

    </script>
</body>
</html>